<!DOCTYPE html><html lang="zh-TW"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動訓練管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49B8'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Header -->
    <header class="bg-primary dark:bg-primary-dark text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold flex items-center">
                    <i class="fas fa-dumbbell mr-2"></i>
                    運動訓練管理系統
                </h1>
                <div class="flex items-center space-x-4">
                    <div class="text-sm">
                        <span id="currentDate" class="font-medium"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- User Role Selection -->
    <div id="roleSelection" class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">選擇身份</h2>
            <div class="space-y-4">
                <button onclick="selectRole('coach')" class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-user-tie mr-3 text-xl"></i>
                    <span class="text-lg">教練</span>
                </button>
                <button onclick="selectRole('athlete')" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-running mr-3 text-xl"></i>
                    <span class="text-lg">運動員</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Athlete Selection -->
    <div id="athleteSelection" class="hidden container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">選擇運動員</h2>
            <button onclick="selectRole('')" class="mb-4 text-primary hover:text-primary-dark text-sm flex items-center">
                <i class="fas fa-arrow-left mr-1"></i> 返回身份選擇
            </button>
            <div id="athleteList" class="space-y-3">
                <!-- Athletes will be listed here -->
            </div>
        </div>
    </div>

    <!-- Coach Interface -->
    <div id="coachInterface" class="hidden">
        <!-- Coach Navigation -->
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-wrap items-center justify-between bg-gray-100 dark:bg-gray-800 rounded-lg p-4 gap-4">
                <button onclick="selectRole('')" class="text-primary hover:text-primary-dark text-sm flex items-center">
                    <i class="fas fa-arrow-left mr-1"></i> 返回身份選擇
                </button>
                <div class="flex space-x-2">
                    <button onclick="showCoachSection('athletes')" id="athletesTab" class="px-4 py-2 rounded-lg transition-colors bg-primary text-white">
                        運動員管理
                    </button>
                    <button onclick="showCoachSection('training')" id="trainingTab" class="px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                        訓練計劃
                    </button>
                    <button onclick="showCoachSection('analytics')" id="analyticsTab" class="px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i class="fas fa-chart-bar mr-1"></i>數據分析
                    </button>
                    <button onclick="showCoachSection('competitions')" id="competitionsTab" class="px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i class="fas fa-trophy mr-1"></i>比賽管理
                    </button>
                </div>
            </div>
        </div>

        <!-- Athletes Management Section -->
        <div id="athletesSection" class="container mx-auto px-4 pb-8">
            <div class="max-w-4xl mx-auto">
                <!-- Excel Import Section -->
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-file-excel mr-2 text-green-600"></i>Excel 批量匯入
                    </h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">匯入運動員資料</label>
                                <input type="file" id="athleteExcelFile" accept=".xlsx,.xls" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">格式：姓名 | 專項 | 備註</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">匯入訓練計劃</label>
                                <input type="file" id="trainingExcelFile" accept=".xlsx,.xls" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">格式：日期 | 運動員/群組 | 項目 | 周期 | 組數 | 次數 | 重量 | 備註</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <button onclick="importAthletes()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-upload mr-2"></i>匯入運動員
                            </button>
                            <button onclick="importTrainingPlans()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-upload mr-2"></i>匯入訓練計劃
                            </button>
                            <button onclick="downloadAthleteTemplate()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>下載運動員範本
                            </button>
                            <button onclick="downloadTrainingTemplate()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>下載訓練計劃範本
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Athlete Form -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">新增運動員</h4>
                    <form id="athleteForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">姓名</label>
                                <input type="text" id="athleteName" required="" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">專項</label>
                                <select id="athleteCategory" required="" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">選擇專項</option>
                                <option value="sprint">短跑</option>
                                <option value="400m">400米</option>
                                <option value="800m">800米</option>
                                <option value="shorthurdles">短欄</option>
                                <option value="hurdles400m">400米欄</option>
                                <option value="longjump">跳遠</option>
                                <option value="triplejump">三級跳遠</option>
                                <option value="highjump">跳高</option>
                                <option value="polevault">撐竿跳高</option>
                                <option value="shotput">鉛球</option>
                                <option value="discus">鐵餅</option>
                                <option value="javelin">標槍</option>
                                <option value="decathlon">十項全能</option>
                                <option value="heptathlon">七項全能</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">備註</label>
                            <input type="text" id="athleteNotes" placeholder="年齡、經驗、特殊需求等" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            新增運動員
                        </button>
                    </form>
                </div>

                <!-- Athletes List -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white">運動員列表</h4>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-400">篩選專項:</label>
                            <select id="categoryFilter" onchange="filterAthletes()" class="text-sm px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">選擇專項</option>
                                <option value="sprint">短跑</option>
                                <option value="400m">400米</option>
                                <option value="800m">800米</option>
                                <option value="shorthurdles">短欄</option>
                                <option value="hurdles400m">400米欄</option>
                                <option value="longjump">跳遠</option>
                                <option value="triplejump">三級跳遠</option>
                                <option value="highjump">跳高</option>
                                <option value="polevault">撐竿跳高</option>
                                <option value="shotput">鉛球</option>
                                <option value="discus">鐵餅</option>
                                <option value="javelin">標槍</option>
                                <option value="decathlon">十項全能</option>
                                <option value="heptathlon">七項全能</option>
                            </select>
                        </div>
                    </div>
                    <div id="athletesDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Athletes will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="hidden container mx-auto px-4 pb-8">
            <div class="max-w-6xl mx-auto">
                <!-- Analytics Controls -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">數據分析儀表板</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400">分析範圍:</label>
                                <select id="analyticsRange" onchange="loadAnalytics()" class="text-sm px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="7">過去7天</option>
                                    <option value="30">過去30天</option>
                                    <option value="90">過去90天</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400">分析目標:</label>
                                <select id="analyticsTarget" onchange="loadAnalytics()" class="text-sm px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="all">全部運動員</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-sm text-gray-600 dark:text-gray-400">總訓練次數</p>
                                <p id="totalSessions" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                            <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <i class="fas fa-calendar-check text-blue-600 dark:text-blue-300 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-sm text-gray-600 dark:text-gray-400">平均完成率</p>
                                <p id="avgCompletion" class="text-2xl font-bold text-gray-900 dark:text-white">0%</p>
                            </div>
                            <div class="p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                                <i class="fas fa-check-circle text-green-600 dark:text-green-300 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-sm text-gray-600 dark:text-gray-400">活躍運動員</p>
                                <p id="activeAthletes" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                            <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
                                <i class="fas fa-users text-purple-600 dark:text-purple-300 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-sm text-gray-600 dark:text-gray-400">總訓練項目</p>
                                <p id="totalExercises" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                            <div class="p-3 bg-orange-100 dark:bg-orange-900 rounded-lg">
                                <i class="fas fa-dumbbell text-orange-600 dark:text-orange-300 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Completion Rate Chart -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">訓練完成率趨勢</h4>
                        <div class="relative h-64">
                            <canvas id="completionChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Category Distribution Chart -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">專項分布</h4>
                        <div class="relative h-64">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Performance Table -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">運動員表現統計</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">運動員</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">專項</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">訓練次數</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">完成率</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">活躍度</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">最近訓練</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <!-- Performance data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Competitions Management Section -->
        <div id="competitionsSection" class="hidden container mx-auto px-4 pb-8">
            <div class="max-w-4xl mx-auto">
                <!-- Add Competition Form -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">新增比賽記錄</h4>
                    <form id="competitionForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">運動員</label>
                                <select id="competitionAthlete" required="" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="">選擇運動員</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">比賽日期</label>
                                <input type="date" id="competitionDate" required="" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">比賽名稱</label>
                                <input type="text" id="competitionName" required="" placeholder="例：全國田徑錦標賽" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">比賽項目</label>
                                <select id="competitionEvent" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="100m">100米</option>
                                    <option value="200m">200米</option>
                                    <option value="400m">400米</option>
                                    <option value="800m">800米</option>
                                    <option value="1500m">1500米</option>
                                    <option value="110mh">110米跨欄</option>
                                    <option value="400mh">400米跨欄</option>
                                    <option value="high_jump">跳高</option>
                                    <option value="long_jump">跳遠</option>
                                    <option value="shot_put">鉛球</option>
                                    <option value="javelin">標槍</option>
                                    <option value="decathlon">十項全能</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">成績</label>
                                <input type="text" id="competitionResult" required="" placeholder="例：10.85秒 或 7.45米" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">名次</label>
                                <input type="number" id="competitionRank" min="1" placeholder="第幾名" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">等級</label>
                                <select id="competitionLevel" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="school">校級</option>
                                    <option value="city">市級</option>
                                    <option value="regional">區域級</option>
                                    <option value="national">全國級</option>
                                    <option value="international">國際級</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">備註</label>
                            <textarea id="competitionNotes" rows="2" placeholder="個人最佳、賽況描述、天氣條件等" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                        </div>
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            新增比賽記錄
                        </button>
                    </form>
                </div>

                <!-- Competitions List -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white">比賽記錄</h4>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-400">篩選運動員:</label>
                            <select id="competitionAthleteFilter" onchange="filterCompetitions()" class="text-sm px-2 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">全部</option>
                            </select>
                        </div>
                    </div>
                    <div id="competitionsDisplay" class="space-y-4">
                        <!-- Competitions will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Management Section -->
        <div id="trainingSection" class="hidden container mx-auto px-4 pb-8">
            <div class="max-w-4xl mx-auto">
                <!-- Date and Athlete Selection -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <button onclick="changeDate(-1)" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 p-2 rounded-lg transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="text-center">
                                <h3 id="selectedDate" class="text-lg font-semibold text-gray-800 dark:text-white"></h3>
                            </div>
                            <button onclick="changeDate(1)" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 p-2 rounded-lg transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-400">選擇目標:</label>
                            <select id="trainingTarget" onchange="loadTrainingPlan()" class="text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">選擇運動員或群組</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Training Plan Form -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">新增/編輯訓練項目</h4>
                    <form id="trainingForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">訓練項目</label>
                                <input type="text" id="exerciseName" required="" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">訓練周期</label>
                                <select id="trainingPhase" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="base">基礎期</option>
                                    <option value="build">建構期</option>
                                    <option value="peak">尖峰期</option>
                                    <option value="competition">比賽期</option>
                                    <option value="recovery">恢復期</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">組數</label>
                                <input type="number" id="sets" min="1" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">次數/時間</label>
                                <input type="text" id="reps" placeholder="例：12次 或 30秒" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">重量/強度</label>
                                <input type="text" id="weight" placeholder="例：50kg 或 中等" class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">備註</label>
                            <textarea id="notes" rows="2" placeholder="訓練重點、注意事項..." class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                        </div>
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            新增訓練項目
                        </button>
                    </form>
                </div>

                <!-- Training Plan List -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">訓練計劃</h4>
                    <div id="trainingPlanList" class="space-y-3">
                        <!-- Training items will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Athlete Interface -->
    <div id="athleteInterface" class="hidden">
        <!-- Navigation -->
        <div class="container mx-auto px-4 py-4">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeDate(-1)" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 p-2 rounded-lg transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="text-center">
                        <h3 id="selectedDateAthlete" class="text-lg font-semibold text-gray-800 dark:text-white"></h3>
                        <p id="athleteInfo" class="text-sm text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <button onclick="changeDate(1)" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 p-2 rounded-lg transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <button onclick="selectRole('athlete')" class="text-primary hover:text-primary-dark text-sm flex items-center">
                    <i class="fas fa-arrow-left mr-1"></i> 返回運動員選擇
                </button>
            </div>
        </div>

        <!-- Training Plan View -->
        <div class="container mx-auto px-4 pb-8">
            <div class="max-w-2xl mx-auto">
                <div id="athleteTrainingPlan" class="space-y-4">
                    <!-- Training plan will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for confirmations -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <p id="confirmMessage" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideConfirmModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">取消</button>
                <button id="confirmButton" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">確認</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentDate = new Date();
        let currentRole = '';
        let currentAthlete = null;
        let editingIndex = -1;
        let athletes = []; // Store athletes data
        let trainingData = {}; // Store training data by date and athlete/group
        let competitions = []; // Store competition data
        let currentCoachSection = 'athletes';

        // Category translations
        const categoryNames = {
            '100m': '100米',
            '200m': '200米', 
            '400m': '400米',
            '800m': '800米',
            '1500m': '1500米',
            '110mh': '110米跨欄',
            '400mh': '400米跨欄',
            'high_jump': '跳高',
            'long_jump': '跳遠',
            'shot_put': '鉛球',
            'javelin': '標槍',
            'decathlon': '十項全能'
        };

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            updateSelectedDate();
            initializeSampleData();
        });

        function initializeSampleData() {
            // Add some sample athletes
            athletes = [
                { id: 1, name: '張小明', category: '100m', notes: '有潛力的新手' },
                { id: 2, name: '李小華', category: '400mh', notes: '經驗豐富' },
                { id: 3, name: '王小美', category: 'long_jump', notes: '技術需要改進' },
                { id: 4, name: '陳小強', category: '100m', notes: '速度很快' }
            ];
        }

        function updateCurrentDate() {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('zh-TW', options);
        }

        function updateSelectedDate() {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            const dateStr = currentDate.toLocaleDateString('zh-TW', options);
            if (document.getElementById('selectedDate')) {
                document.getElementById('selectedDate').textContent = dateStr;
            }
            if (document.getElementById('selectedDateAthlete')) {
                document.getElementById('selectedDateAthlete').textContent = dateStr;
            }
        }

        function selectRole(role) {
            currentRole = role;
            
            // Hide all interfaces
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('athleteSelection').classList.add('hidden');
            document.getElementById('coachInterface').classList.add('hidden');
            document.getElementById('athleteInterface').classList.add('hidden');

            if (role === 'coach') {
                document.getElementById('coachInterface').classList.remove('hidden');
                showCoachSection('athletes');
            } else if (role === 'athlete') {
                document.getElementById('athleteSelection').classList.remove('hidden');
                loadAthleteSelection();
            } else {
                document.getElementById('roleSelection').classList.remove('hidden');
            }
        }

        function selectAthlete(athleteId) {
            currentAthlete = athletes.find(a => a.id === athleteId);
            document.getElementById('athleteSelection').classList.add('hidden');
            document.getElementById('athleteInterface').classList.remove('hidden');
            updateAthleteInfo();
            loadAthleteView();
        }

        function updateAthleteInfo() {
            if (currentAthlete) {
                document.getElementById('athleteInfo').textContent = 
                    `${currentAthlete.name} - ${categoryNames[currentAthlete.category]}`;
            }
        }

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateSelectedDate();
            
            if (currentRole === 'coach' && currentCoachSection === 'training') {
                loadTrainingPlan();
            } else if (currentRole === 'athlete') {
                loadAthleteView();
            }
        }

        function getDateKey() {
            return currentDate.toDateString();
        }

        // Coach functions
        function showCoachSection(section) {
            currentCoachSection = section;
            
            // Update tab appearances
            document.getElementById('athletesTab').className = section === 'athletes' 
                ? 'px-4 py-2 rounded-lg transition-colors bg-primary text-white'
                : 'px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
            
            document.getElementById('trainingTab').className = section === 'training' 
                ? 'px-4 py-2 rounded-lg transition-colors bg-primary text-white'
                : 'px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';

            document.getElementById('analyticsTab').className = section === 'analytics' 
                ? 'px-4 py-2 rounded-lg transition-colors bg-primary text-white'
                : 'px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
            
            document.getElementById('competitionsTab').className = section === 'competitions' 
                ? 'px-4 py-2 rounded-lg transition-colors bg-primary text-white'
                : 'px-4 py-2 rounded-lg transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';
            
            // Show/hide sections
            document.getElementById('athletesSection').classList.toggle('hidden', section !== 'athletes');
            document.getElementById('trainingSection').classList.toggle('hidden', section !== 'training');
            document.getElementById('analyticsSection').classList.toggle('hidden', section !== 'analytics');
            document.getElementById('competitionsSection').classList.toggle('hidden', section !== 'competitions');
            
            if (section === 'athletes') {
                displayAthletes();
            } else if (section === 'training') {
                updateTrainingTargets();
                loadTrainingPlan();
            } else if (section === 'analytics') {
                updateAnalyticsTargets();
                loadAnalytics();
            } else if (section === 'competitions') {
                updateCompetitionSelectors();
                displayCompetitions();
            }
        }

        // Athlete management
        document.getElementById('athleteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('athleteName').value;
            const category = document.getElementById('athleteCategory').value;
            const notes = document.getElementById('athleteNotes').value;

            const newAthlete = {
                id: Date.now(),
                name: name,
                category: category,
                notes: notes
            };

            athletes.push(newAthlete);
            this.reset();
            displayAthletes();
            updateTrainingTargets();
        });

        function displayAthletes() {
            const container = document.getElementById('athletesDisplay');
            const filter = document.getElementById('categoryFilter').value;
            
            const filteredAthletes = filter ? athletes.filter(a => a.category === filter) : athletes;

            if (filteredAthletes.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">尚未新增運動員</div>';
                return;
            }

            container.innerHTML = filteredAthletes.map(athlete => `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-semibold text-gray-800 dark:text-white">${athlete.name}</h5>
                        <button onclick="showDeleteAthleteConfirm(${athlete.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs">
                            ${categoryNames[athlete.category]}
                        </span>
                    </div>
                    ${athlete.notes ? `<p class="text-sm text-gray-600 dark:text-gray-400">${athlete.notes}</p>` : ''}
                </div>
            `).join('');
        }

        function filterAthletes() {
            displayAthletes();
        }

        function showDeleteAthleteConfirm(athleteId) {
            const athlete = athletes.find(a => a.id === athleteId);
            document.getElementById('confirmMessage').textContent = `確定要刪除運動員 ${athlete.name} 嗎？`;
            document.getElementById('confirmButton').onclick = () => {
                deleteAthlete(athleteId);
                hideConfirmModal();
            };
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function deleteAthlete(athleteId) {
            athletes = athletes.filter(a => a.id !== athleteId);
            displayAthletes();
            updateTrainingTargets();
        }

        function updateTrainingTargets() {
            const select = document.getElementById('trainingTarget');
            if (!select) return;
            
            const currentValue = select.value;
            
            // Create options for individual athletes and categories
            let options = '<option value="">選擇運動員或群組</option>';
            
            // Add category groups
            const categories = [...new Set(athletes.map(a => a.category))];
            categories.forEach(category => {
                options += `<option value="category:${category}">群組: ${categoryNames[category]}</option>`;
            });
            
            // Add individual athletes
            athletes.forEach(athlete => {
                options += `<option value="athlete:${athlete.id}">${athlete.name} (${categoryNames[athlete.category]})</option>`;
            });
            
            select.innerHTML = options;
            select.value = currentValue;
        }

        // Training management
        document.getElementById('trainingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const target = document.getElementById('trainingTarget').value;
            if (!target) {
                showAlert('請先選擇訓練對象');
                return;
            }
            
            const exerciseName = document.getElementById('exerciseName').value;
            const trainingPhase = document.getElementById('trainingPhase').value;
            const sets = document.getElementById('sets').value;
            const reps = document.getElementById('reps').value;
            const weight = document.getElementById('weight').value;
            const notes = document.getElementById('notes').value;

            const exercise = {
                name: exerciseName,
                phase: trainingPhase,
                sets: sets,
                reps: reps,
                weight: weight,
                notes: notes,
                completed: false,
                performance: ''
            };

            const dateKey = getDateKey();
            const trainingKey = `${dateKey}:${target}`;
            
            if (!trainingData[trainingKey]) {
                trainingData[trainingKey] = [];
            }

            if (editingIndex >= 0) {
                trainingData[trainingKey][editingIndex] = exercise;
                editingIndex = -1;
                document.querySelector('#trainingForm button[type="submit"]').textContent = '新增訓練項目';
            } else {
                trainingData[trainingKey].push(exercise);
            }

            this.reset();
            loadTrainingPlan();
        });

        function loadTrainingPlan() {
            const target = document.getElementById('trainingTarget').value;
            const listContainer = document.getElementById('trainingPlanList');

            if (!target) {
                listContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">請選擇訓練對象</p>';
                return;
            }

            const dateKey = getDateKey();
            const trainingKey = `${dateKey}:${target}`;
            const exercises = trainingData[trainingKey] || [];

            if (exercises.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚未安排訓練項目</p>';
                return;
            }

            listContainer.innerHTML = exercises.map((exercise, index) => `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-semibold text-gray-800 dark:text-white">${exercise.name}</h5>
                        <div class="flex space-x-2">
                            <button onclick="editExercise(${index})" class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showDeleteConfirm(${index})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm text-gray-600 dark:text-gray-400 mb-2">
                        ${exercise.sets ? `<div><span class="font-medium">組數:</span> ${exercise.sets}</div>` : ''}
                        ${exercise.reps ? `<div><span class="font-medium">次數:</span> ${exercise.reps}</div>` : ''}
                        ${exercise.weight ? `<div><span class="font-medium">重量:</span> ${exercise.weight}</div>` : ''}
                    </div>
                    ${exercise.notes ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-2">${exercise.notes}</p>` : ''}
                </div>
            `).join('');
        }

        function editExercise(index) {
            const target = document.getElementById('trainingTarget').value;
            const dateKey = getDateKey();
            const trainingKey = `${dateKey}:${target}`;
            const exercise = trainingData[trainingKey][index];
            
            document.getElementById('exerciseName').value = exercise.name;
            document.getElementById('trainingPhase').value = exercise.phase;
            document.getElementById('sets').value = exercise.sets;
            document.getElementById('reps').value = exercise.reps;
            document.getElementById('weight').value = exercise.weight;
            document.getElementById('notes').value = exercise.notes;
            
            editingIndex = index;
            document.querySelector('#trainingForm button[type="submit"]').textContent = '更新訓練項目';
        }

        function showDeleteConfirm(index) {
            document.getElementById('confirmMessage').textContent = '確定要刪除這個訓練項目嗎？';
            document.getElementById('confirmButton').onclick = () => {
                deleteExercise(index);
                hideConfirmModal();
            };
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function deleteExercise(index) {
            const target = document.getElementById('trainingTarget').value;
            const dateKey = getDateKey();
            const trainingKey = `${dateKey}:${target}`;
            trainingData[trainingKey].splice(index, 1);
            loadTrainingPlan();
        }

        // Athlete functions
        function loadAthleteSelection() {
            const container = document.getElementById('athleteList');
            
            if (athletes.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">尚未有運動員註冊</div>';
                return;
            }

            container.innerHTML = athletes.map(athlete => `
                <button onclick="selectAthlete(${athlete.id})" 
                        class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-semibold text-gray-800 dark:text-white">${athlete.name}</h5>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${categoryNames[athlete.category]}</p>
                            ${athlete.notes ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${athlete.notes}</p>` : ''}
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </button>
            `).join('');
        }

        function loadAthleteView() {
            if (!currentAthlete) return;
            
            const dateKey = getDateKey();
            const container = document.getElementById('athleteTrainingPlan');
            
            // Check both individual and category training plans
            const individualKey = `${dateKey}:athlete:${currentAthlete.id}`;
            const categoryKey = `${dateKey}:category:${currentAthlete.category}`;
            
            const individualExercises = trainingData[individualKey] || [];
            const categoryExercises = trainingData[categoryKey] || [];
            
            const allExercises = [...individualExercises, ...categoryExercises];

            if (allExercises.length === 0) {
                container.innerHTML = '<div class="text-center py-12"><i class="fas fa-calendar-alt text-4xl text-gray-400 dark:text-gray-600 mb-4"></i><p class="text-gray-500 dark:text-gray-400">今日沒有安排訓練項目</p></div>';
                return;
            }

            container.innerHTML = allExercises.map((exercise, index) => {
                const isIndividual = index < individualExercises.length;
                const actualIndex = isIndividual ? index : index - individualExercises.length;
                const trainingType = isIndividual ? 'individual' : 'category';
                
                return `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h5 class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.name}</h5>
                            <span class="text-xs px-2 py-1 rounded ${isIndividual ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'}">
                                ${isIndividual ? '個人訓練' : '群組訓練'}
                            </span>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="completed_${trainingType}_${actualIndex}" ${exercise.completed ? 'checked' : ''} 
                                   onchange="toggleCompleted('${trainingType}', ${actualIndex})"
                                   class="w-5 h-5 text-primary focus:ring-primary border-gray-300 rounded">
                            <label for="completed_${trainingType}_${actualIndex}" class="ml-2 text-sm text-gray-600 dark:text-gray-400">完成</label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        ${exercise.sets ? `<div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><div class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.sets}</div><div class="text-sm text-gray-500 dark:text-gray-400">組數</div></div>` : ''}
                        ${exercise.reps ? `<div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><div class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.reps}</div><div class="text-sm text-gray-500 dark:text-gray-400">次數/時間</div></div>` : ''}
                        ${exercise.weight ? `<div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><div class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.weight}</div><div class="text-sm text-gray-500 dark:text-gray-400">重量/強度</div></div>` : ''}
                    </div>
                    
                    ${exercise.notes ? `<div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg"><p class="text-sm text-blue-800 dark:text-blue-200"><i class="fas fa-info-circle mr-2"></i>${exercise.notes}</p></div>` : ''}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">表現記錄</label>
                        <textarea id="performance_${trainingType}_${actualIndex}" rows="2" 
                                  placeholder="記錄實際完成情況、感受、備註..." 
                                  onchange="updatePerformance('${trainingType}', ${actualIndex})"
                                  class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">${exercise.performance || ''}</textarea>
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleCompleted(trainingType, index) {
            const dateKey = getDateKey();
            const checkbox = document.getElementById(`completed_${trainingType}_${index}`);
            
            let trainingKey;
            if (trainingType === 'individual') {
                trainingKey = `${dateKey}:athlete:${currentAthlete.id}`;
            } else {
                trainingKey = `${dateKey}:category:${currentAthlete.category}`;
            }
            
            trainingData[trainingKey][index].completed = checkbox.checked;
        }

        function updatePerformance(trainingType, index) {
            const dateKey = getDateKey();
            const textarea = document.getElementById(`performance_${trainingType}_${index}`);
            
            let trainingKey;
            if (trainingType === 'individual') {
                trainingKey = `${dateKey}:athlete:${currentAthlete.id}`;
            } else {
                trainingKey = `${dateKey}:category:${currentAthlete.category}`;
            }
            
            trainingData[trainingKey][index].performance = textarea.value;
        }

        // Modal functions
        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Analytics functions
        let completionChart = null;
        let categoryChart = null;

        function updateAnalyticsTargets() {
            const select = document.getElementById('analyticsTarget');
            if (!select) return;
            
            const currentValue = select.value;
            
            let options = '<option value="all">全部運動員</option>';
            
            // Add category groups
            const categories = [...new Set(athletes.map(a => a.category))];
            categories.forEach(category => {
                options += `<option value="category:${category}">專項: ${categoryNames[category]}</option>`;
            });
            
            // Add individual athletes
            athletes.forEach(athlete => {
                options += `<option value="athlete:${athlete.id}">${athlete.name}</option>`;
            });
            
            select.innerHTML = options;
            select.value = currentValue;
        }

        function loadAnalytics() {
            const range = parseInt(document.getElementById('analyticsRange').value);
            const target = document.getElementById('analyticsTarget').value;
            
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - range);
            
            const analyticsData = calculateAnalytics(startDate, endDate, target);
            
            updateSummaryCards(analyticsData);
            updateCompletionChart(analyticsData.dailyCompletion);
            updateCategoryChart(analyticsData.categoryStats);
            updatePerformanceTable(analyticsData.athleteStats);
        }

        function calculateAnalytics(startDate, endDate, target) {
            const dateRange = [];
            const currentDate = new Date(startDate);
            
            // Generate date range
            while (currentDate <= endDate) {
                dateRange.push(currentDate.toDateString());
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let totalSessions = 0;
            let totalExercises = 0;
            let completedExercises = 0;
            const dailyCompletion = [];
            const categoryStats = {};
            const athleteStats = {};
            const activeAthletes = new Set();
            
            // Initialize athlete stats
            athletes.forEach(athlete => {
                athleteStats[athlete.id] = {
                    name: athlete.name,
                    category: athlete.category,
                    sessions: 0,
                    totalExercises: 0,
                    completedExercises: 0,
                    lastTraining: null
                };
            });
            
            // Process training data for each date
            dateRange.forEach(dateKey => {
                let dayTotal = 0;
                let dayCompleted = 0;
                let dayHasSessions = false;
                
                Object.keys(trainingData).forEach(trainingKey => {
                    if (!trainingKey.startsWith(dateKey)) return;
                    
                    const exercises = trainingData[trainingKey];
                    if (exercises.length === 0) return;
                    
                    const [, targetPart] = trainingKey.split(':');
                    
                    // Filter by target if specified
                    if (target !== 'all') {
                        if (target.startsWith('category:')) {
                            const targetCategory = target.split(':')[1];
                            if (targetPart !== `category:${targetCategory}`) return;
                        } else if (target.startsWith('athlete:')) {
                            const targetAthleteId = target.split(':')[1];
                            if (targetPart !== `athlete:${targetAthleteId}`) return;
                        }
                    }
                    
                    dayHasSessions = true;
                    
                    exercises.forEach(exercise => {
                        dayTotal++;
                        totalExercises++;
                        
                        if (exercise.completed) {
                            dayCompleted++;
                            completedExercises++;
                        }
                        
                        // Update athlete stats
                        if (targetPart.startsWith('athlete:')) {
                            const athleteId = parseInt(targetPart.split(':')[1]);
                            if (athleteStats[athleteId]) {
                                athleteStats[athleteId].totalExercises++;
                                if (exercise.completed) {
                                    athleteStats[athleteId].completedExercises++;
                                }
                                athleteStats[athleteId].lastTraining = dateKey;
                                activeAthletes.add(athleteId);
                            }
                        } else if (targetPart.startsWith('category:')) {
                            const category = targetPart.split(':')[1];
                            athletes.filter(a => a.category === category).forEach(athlete => {
                                athleteStats[athlete.id].totalExercises++;
                                if (exercise.completed) {
                                    athleteStats[athlete.id].completedExercises++;
                                }
                                athleteStats[athlete.id].lastTraining = dateKey;
                                activeAthletes.add(athlete.id);
                            });
                        }
                    });
                });
                
                if (dayHasSessions) {
                    totalSessions++;
                    // Update athlete session count
                    Object.keys(trainingData).forEach(trainingKey => {
                        if (!trainingKey.startsWith(dateKey)) return;
                        const exercises = trainingData[trainingKey];
                        if (exercises.length === 0) return;
                        
                        const [, targetPart] = trainingKey.split(':');
                        if (targetPart.startsWith('athlete:')) {
                            const athleteId = parseInt(targetPart.split(':')[1]);
                            if (athleteStats[athleteId]) {
                                athleteStats[athleteId].sessions++;
                            }
                        }
                    });
                }
                
                const completionRate = dayTotal > 0 ? (dayCompleted / dayTotal) * 100 : 0;
                dailyCompletion.push({
                    date: new Date(dateKey).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }),
                    completion: completionRate
                });
            });
            
            // Calculate category stats
            athletes.forEach(athlete => {
                const category = athlete.category;
                if (!categoryStats[category]) {
                    categoryStats[category] = {
                        name: categoryNames[category],
                        count: 0,
                        totalExercises: 0,
                        completedExercises: 0
                    };
                }
                categoryStats[category].count++;
                categoryStats[category].totalExercises += athleteStats[athlete.id].totalExercises;
                categoryStats[category].completedExercises += athleteStats[athlete.id].completedExercises;
            });
            
            const avgCompletion = totalExercises > 0 ? (completedExercises / totalExercises) * 100 : 0;
            
            return {
                totalSessions,
                totalExercises,
                completedExercises,
                avgCompletion,
                activeAthletes: activeAthletes.size,
                dailyCompletion,
                categoryStats,
                athleteStats
            };
        }

        function updateSummaryCards(data) {
            document.getElementById('totalSessions').textContent = data.totalSessions;
            document.getElementById('avgCompletion').textContent = `${Math.round(data.avgCompletion)}%`;
            document.getElementById('activeAthletes').textContent = data.activeAthletes;
            document.getElementById('totalExercises').textContent = data.totalExercises;
        }

        function updateCompletionChart(dailyData) {
            const ctx = document.getElementById('completionChart').getContext('2d');
            
            if (completionChart) {
                completionChart.destroy();
            }
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            completionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => d.date),
                    datasets: [{
                        label: '完成率 (%)',
                        data: dailyData.map(d => d.completion),
                        borderColor: '#5D5CDE',
                        backgroundColor: 'rgba(93, 92, 222, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }

        function updateCategoryChart(categoryData) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            
            const categories = Object.values(categoryData);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        data: categories.map(c => c.count),
                        backgroundColor: colors.slice(0, categories.length),
                        borderWidth: 2,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function updatePerformanceTable(athleteData) {
            const tbody = document.getElementById('performanceTableBody');
            
            const sortedAthletes = Object.values(athleteData)
                .filter(athlete => athlete.totalExercises > 0)
                .sort((a, b) => b.sessions - a.sessions);
            
            if (sortedAthletes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500 dark:text-gray-400">暫無訓練數據</td></tr>';
                return;
            }
            
            tbody.innerHTML = sortedAthletes.map(athlete => {
                const completionRate = athlete.totalExercises > 0 
                    ? Math.round((athlete.completedExercises / athlete.totalExercises) * 100)
                    : 0;
                
                const activityLevel = athlete.sessions >= 5 ? '高' : athlete.sessions >= 2 ? '中' : '低';
                const activityColor = athlete.sessions >= 5 ? 'text-green-600 dark:text-green-400' : 
                                    athlete.sessions >= 2 ? 'text-yellow-600 dark:text-yellow-400' : 
                                    'text-red-600 dark:text-red-400';
                
                const lastTraining = athlete.lastTraining 
                    ? new Date(athlete.lastTraining).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })
                    : '無';
                
                return `
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">${athlete.name}</td>
                        <td class="py-3 px-4 text-gray-600 dark:text-gray-400">${categoryNames[athlete.category]}</td>
                        <td class="py-3 px-4 text-center text-gray-900 dark:text-white">${athlete.sessions}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                completionRate >= 80 ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                                completionRate >= 60 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                                'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                            }">
                                ${completionRate}%
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <span class="${activityColor} font-medium">${activityLevel}</span>
                        </td>
                        <td class="py-3 px-4 text-gray-600 dark:text-gray-400">${lastTraining}</td>
                    </tr>
                `;
            }).join('');
        }

        // Competition management functions
        const phaseNames = {
            'base': '基礎期',
            'build': '建構期',
            'peak': '尖峰期',
            'competition': '比賽期',
            'recovery': '恢復期'
        };

        const levelNames = {
            'school': '校級',
            'city': '市級',
            'regional': '區域級',
            'national': '全國級',
            'international': '國際級'
        };

        document.getElementById('competitionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const athleteId = parseInt(document.getElementById('competitionAthlete').value);
            const date = document.getElementById('competitionDate').value;
            const name = document.getElementById('competitionName').value;
            const event = document.getElementById('competitionEvent').value;
            const result = document.getElementById('competitionResult').value;
            const rank = document.getElementById('competitionRank').value;
            const level = document.getElementById('competitionLevel').value;
            const notes = document.getElementById('competitionNotes').value;

            const competition = {
                id: Date.now(),
                athleteId: athleteId,
                date: date,
                name: name,
                event: event,
                result: result,
                rank: rank ? parseInt(rank) : null,
                level: level,
                notes: notes
            };

            competitions.push(competition);
            this.reset();
            displayCompetitions();
        });

        function updateCompetitionSelectors() {
            // Update athlete selector in form
            const athleteSelect = document.getElementById('competitionAthlete');
            const currentValue = athleteSelect.value;
            
            let options = '<option value="">選擇運動員</option>';
            athletes.forEach(athlete => {
                options += `<option value="${athlete.id}">${athlete.name} (${categoryNames[athlete.category]})</option>`;
            });
            
            athleteSelect.innerHTML = options;
            athleteSelect.value = currentValue;

            // Update filter selector
            const filterSelect = document.getElementById('competitionAthleteFilter');
            const currentFilterValue = filterSelect.value;
            
            let filterOptions = '<option value="">全部</option>';
            athletes.forEach(athlete => {
                filterOptions += `<option value="${athlete.id}">${athlete.name}</option>`;
            });
            
            filterSelect.innerHTML = filterOptions;
            filterSelect.value = currentFilterValue;
        }

        function displayCompetitions() {
            const container = document.getElementById('competitionsDisplay');
            const filter = document.getElementById('competitionAthleteFilter').value;
            
            let filteredCompetitions = competitions;
            if (filter) {
                filteredCompetitions = competitions.filter(c => c.athleteId === parseInt(filter));
            }

            // Sort by date (newest first)
            filteredCompetitions.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredCompetitions.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">尚未有比賽記錄</div>';
                return;
            }

            container.innerHTML = filteredCompetitions.map(competition => {
                const athlete = athletes.find(a => a.id === competition.athleteId);
                const athleteName = athlete ? athlete.name : '未知運動員';
                
                const rankDisplay = competition.rank ? `第${competition.rank}名` : '未註明';
                const levelColor = {
                    'school': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
                    'city': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    'regional': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    'national': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                    'international': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                }[competition.level];

                return `
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h5 class="text-lg font-semibold text-gray-800 dark:text-white">${competition.name}</h5>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">${athleteName}</span>
                                    <span class="text-gray-400">•</span>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">${new Date(competition.date).toLocaleDateString('zh-TW')}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <span class="px-2 py-1 rounded text-xs font-medium ${levelColor}">
                                    ${levelNames[competition.level]}
                                </span>
                                <button onclick="showDeleteCompetitionConfirm(${competition.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm text-gray-500 dark:text-gray-400">項目</div>
                                <div class="font-semibold text-gray-800 dark:text-white">${categoryNames[competition.event]}</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm text-gray-500 dark:text-gray-400">成績</div>
                                <div class="font-semibold text-gray-800 dark:text-white">${competition.result}</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm text-gray-500 dark:text-gray-400">名次</div>
                                <div class="font-semibold text-gray-800 dark:text-white">${rankDisplay}</div>
                            </div>
                        </div>
                        
                        ${competition.notes ? `
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                    <i class="fas fa-sticky-note mr-2"></i>${competition.notes}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterCompetitions() {
            displayCompetitions();
        }

        function showDeleteCompetitionConfirm(competitionId) {
            const competition = competitions.find(c => c.id === competitionId);
            document.getElementById('confirmMessage').textContent = `確定要刪除比賽記錄「${competition.name}」嗎？`;
            document.getElementById('confirmButton').onclick = () => {
                deleteCompetition(competitionId);
                hideConfirmModal();
            };
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function deleteCompetition(competitionId) {
            competitions = competitions.filter(c => c.id !== competitionId);
            displayCompetitions();
        }

        // Enhanced training plan display with phases
        function loadTrainingPlanEnhanced() {
            const target = document.getElementById('trainingTarget').value;
            const listContainer = document.getElementById('trainingPlanList');

            if (!target) {
                listContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">請選擇訓練對象</p>';
                return;
            }

            const dateKey = getDateKey();
            const trainingKey = `${dateKey}:${target}`;
            const exercises = trainingData[trainingKey] || [];

            if (exercises.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚未安排訓練項目</p>';
                return;
            }

            listContainer.innerHTML = exercises.map((exercise, index) => {
                const phaseColor = {
                    'base': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    'build': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    'peak': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                    'competition': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                    'recovery': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'
                }[exercise.phase || 'base'];

                return `
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h5 class="font-semibold text-gray-800 dark:text-white">${exercise.name}</h5>
                                <span class="text-xs px-2 py-1 rounded mt-1 inline-block ${phaseColor}">
                                    ${phaseNames[exercise.phase || 'base']}
                                </span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editExercise(${index})" class="text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="showDeleteConfirm(${index})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-sm text-gray-600 dark:text-gray-400 mb-2">
                            ${exercise.sets ? `<div><span class="font-medium">組數:</span> ${exercise.sets}</div>` : ''}
                            ${exercise.reps ? `<div><span class="font-medium">次數:</span> ${exercise.reps}</div>` : ''}
                            ${exercise.weight ? `<div><span class="font-medium">重量:</span> ${exercise.weight}</div>` : ''}
                        </div>
                        ${exercise.notes ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-2">${exercise.notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Override the original loadTrainingPlan function
        loadTrainingPlan = loadTrainingPlanEnhanced;

        // Enhanced athlete view with phases
        function loadAthleteViewEnhanced() {
            if (!currentAthlete) return;
            
            const dateKey = getDateKey();
            const container = document.getElementById('athleteTrainingPlan');
            
            // Check both individual and category training plans
            const individualKey = `${dateKey}:athlete:${currentAthlete.id}`;
            const categoryKey = `${dateKey}:category:${currentAthlete.category}`;
            
            const individualExercises = trainingData[individualKey] || [];
            const categoryExercises = trainingData[categoryKey] || [];
            
            const allExercises = [...individualExercises, ...categoryExercises];

            if (allExercises.length === 0) {
                // Display competitions for this athlete if no training
                const athleteCompetitions = competitions.filter(c => c.athleteId === currentAthlete.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 3); // Show last 3 competitions

                let competitionDisplay = '';
                if (athleteCompetitions.length > 0) {
                    competitionDisplay = `
                        <div class="mt-8 bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">最近比賽記錄</h4>
                            <div class="space-y-3">
                                ${athleteCompetitions.map(comp => `
                                    <div class="bg-white dark:bg-gray-700 rounded-lg p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h6 class="font-medium text-gray-800 dark:text-white">${comp.name}</h6>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">${categoryNames[comp.event]} • ${comp.result}</p>
                                            </div>
                                            <span class="text-sm text-gray-500 dark:text-gray-400">${new Date(comp.date).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-calendar-alt text-4xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">今日沒有安排訓練項目</p>
                    </div>
                    ${competitionDisplay}
                `;
                return;
            }

            container.innerHTML = allExercises.map((exercise, index) => {
                const isIndividual = index < individualExercises.length;
                const actualIndex = isIndividual ? index : index - individualExercises.length;
                const trainingType = isIndividual ? 'individual' : 'category';
                
                const phaseColor = {
                    'base': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    'build': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    'peak': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                    'competition': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                    'recovery': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'
                }[exercise.phase || 'base'];
                
                return `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h5 class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.name}</h5>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="text-xs px-2 py-1 rounded ${isIndividual ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'}">
                                    ${isIndividual ? '個人訓練' : '群組訓練'}
                                </span>
                                <span class="text-xs px-2 py-1 rounded ${phaseColor}">
                                    ${phaseNames[exercise.phase || 'base']}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="completed_${trainingType}_${actualIndex}" ${exercise.completed ? 'checked' : ''} 
                                   onchange="toggleCompleted('${trainingType}', ${actualIndex})"
                                   class="w-5 h-5 text-primary focus:ring-primary border-gray-300 rounded">
                            <label for="completed_${trainingType}_${actualIndex}" class="ml-2 text-sm text-gray-600 dark:text-gray-400">完成</label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        ${exercise.sets ? `<div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><div class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.sets}</div><div class="text-sm text-gray-500 dark:text-gray-400">組數</div></div>` : ''}
                        ${exercise.reps ? `<div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><div class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.reps}</div><div class="text-sm text-gray-500 dark:text-gray-400">次數/時間</div></div>` : ''}
                        ${exercise.weight ? `<div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><div class="text-lg font-semibold text-gray-800 dark:text-white">${exercise.weight}</div><div class="text-sm text-gray-500 dark:text-gray-400">重量/強度</div></div>` : ''}
                    </div>
                    
                    ${exercise.notes ? `<div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg"><p class="text-sm text-blue-800 dark:text-blue-200"><i class="fas fa-info-circle mr-2"></i>${exercise.notes}</p></div>` : ''}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">表現記錄</label>
                        <textarea id="performance_${trainingType}_${actualIndex}" rows="2" 
                                  placeholder="記錄實際完成情況、感受、備註..." 
                                  onchange="updatePerformance('${trainingType}', ${actualIndex})"
                                  class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">${exercise.performance || ''}</textarea>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Override the original loadAthleteView function
        loadAthleteView = loadAthleteViewEnhanced;

        // Excel Import Functions
        const categoryKeyMapping = {
            '100米': '100m',
            '100m': '100m',
            '200米': '200m', 
            '200m': '200m',
            '400米': '400m',
            '400m': '400m',
            '800米': '800m',
            '800m': '800m',
            '1500米': '1500m',
            '1500m': '1500m',
            '110米跨欄': '110mh',
            '110mh': '110mh',
            '110跨欄': '110mh',
            '400米跨欄': '400mh',
            '400mh': '400mh', 
            '400跨欄': '400mh',
            '跳高': 'high_jump',
            'high_jump': 'high_jump',
            '跳遠': 'long_jump',
            'long_jump': 'long_jump',
            '鉛球': 'shot_put',
            'shot_put': 'shot_put',
            '標槍': 'javelin',
            'javelin': 'javelin',
            '十項全能': 'decathlon',
            'decathlon': 'decathlon'
        };

        const phaseKeyMapping = {
            '基礎期': 'base',
            'base': 'base',
            '建構期': 'build',
            'build': 'build',
            '尖峰期': 'peak',
            'peak': 'peak',
            '比賽期': 'competition',
            'competition': 'competition',
            '恢復期': 'recovery',
            'recovery': 'recovery'
        };

        function importAthletes() {
            const fileInput = document.getElementById('athleteExcelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('請選擇要匯入的Excel檔案');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    let imported = 0;
                    let errors = [];

                    jsonData.forEach((row, index) => {
                        try {
                            // Try different possible column names
                            const name = row['姓名'] || row['Name'] || row['name'] || row['運動員'] || '';
                            const categoryRaw = row['專項'] || row['Category'] || row['category'] || row['項目'] || '';
                            const notes = row['備註'] || row['Notes'] || row['notes'] || row['說明'] || '';

                            if (!name) {
                                errors.push(`第${index + 2}列：缺少姓名`);
                                return;
                            }

                            if (!categoryRaw) {
                                errors.push(`第${index + 2}列：缺少專項`);
                                return;
                            }

                            const category = categoryKeyMapping[categoryRaw.toString().trim()];
                            if (!category) {
                                errors.push(`第${index + 2}列：無效的專項「${categoryRaw}」`);
                                return;
                            }

                            // Check if athlete already exists
                            if (athletes.find(a => a.name === name.toString().trim())) {
                                errors.push(`第${index + 2}列：運動員「${name}」已存在`);
                                return;
                            }

                            const newAthlete = {
                                id: Date.now() + Math.random(),
                                name: name.toString().trim(),
                                category: category,
                                notes: notes.toString().trim()
                            };

                            athletes.push(newAthlete);
                            imported++;
                        } catch (error) {
                            errors.push(`第${index + 2}列：處理錯誤 - ${error.message}`);
                        }
                    });

                    let message = `成功匯入 ${imported} 位運動員`;
                    if (errors.length > 0) {
                        message += `\n\n錯誤：\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... 共 ${errors.length} 個錯誤`;
                        }
                    }

                    showAlert(message);
                    displayAthletes();
                    updateTrainingTargets();
                    updateCompetitionSelectors();
                    fileInput.value = '';

                } catch (error) {
                    showAlert(`檔案讀取錯誤：${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function importTrainingPlans() {
            const fileInput = document.getElementById('trainingExcelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('請選擇要匯入的Excel檔案');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    let imported = 0;
                    let errors = [];

                    jsonData.forEach((row, index) => {
                        try {
                            const dateRaw = row['日期'] || row['Date'] || row['date'] || '';
                            const targetRaw = row['運動員/群組'] || row['Target'] || row['target'] || row['對象'] || '';
                            const exerciseName = row['項目'] || row['Exercise'] || row['exercise'] || row['訓練項目'] || '';
                            const phaseRaw = row['周期'] || row['Phase'] || row['phase'] || row['訓練周期'] || '';
                            const sets = row['組數'] || row['Sets'] || row['sets'] || '';
                            const reps = row['次數'] || row['Reps'] || row['reps'] || row['次數/時間'] || '';
                            const weight = row['重量'] || row['Weight'] || row['weight'] || row['重量/強度'] || '';
                            const notes = row['備註'] || row['Notes'] || row['notes'] || '';

                            if (!dateRaw) {
                                errors.push(`第${index + 2}列：缺少日期`);
                                return;
                            }

                            if (!targetRaw) {
                                errors.push(`第${index + 2}列：缺少運動員/群組`);
                                return;
                            }

                            if (!exerciseName) {
                                errors.push(`第${index + 2}列：缺少訓練項目`);
                                return;
                            }

                            // Parse date
                            let dateKey;
                            try {
                                const date = new Date(dateRaw);
                                if (isNaN(date.getTime())) {
                                    throw new Error('無效日期格式');
                                }
                                dateKey = date.toDateString();
                            } catch (error) {
                                errors.push(`第${index + 2}列：日期格式錯誤「${dateRaw}」`);
                                return;
                            }

                            // Parse target
                            let target;
                            const targetStr = targetRaw.toString().trim();
                            
                            // Check if it's a category
                            const categoryKey = categoryKeyMapping[targetStr];
                            if (categoryKey) {
                                target = `category:${categoryKey}`;
                            } else {
                                // Check if it's an athlete name
                                const athlete = athletes.find(a => a.name === targetStr);
                                if (athlete) {
                                    target = `athlete:${athlete.id}`;
                                } else {
                                    errors.push(`第${index + 2}列：找不到運動員或群組「${targetStr}」`);
                                    return;
                                }
                            }

                            // Parse phase
                            let phase = 'base';
                            if (phaseRaw) {
                                const phaseKey = phaseKeyMapping[phaseRaw.toString().trim()];
                                if (phaseKey) {
                                    phase = phaseKey;
                                } else {
                                    errors.push(`第${index + 2}列：無效的訓練周期「${phaseRaw}」，使用預設值`);
                                }
                            }

                            const exercise = {
                                name: exerciseName.toString().trim(),
                                phase: phase,
                                sets: sets.toString().trim(),
                                reps: reps.toString().trim(),
                                weight: weight.toString().trim(),
                                notes: notes.toString().trim(),
                                completed: false,
                                performance: ''
                            };

                            const trainingKey = `${dateKey}:${target}`;
                            if (!trainingData[trainingKey]) {
                                trainingData[trainingKey] = [];
                            }
                            trainingData[trainingKey].push(exercise);
                            imported++;

                        } catch (error) {
                            errors.push(`第${index + 2}列：處理錯誤 - ${error.message}`);
                        }
                    });

                    let message = `成功匯入 ${imported} 個訓練項目`;
                    if (errors.length > 0) {
                        message += `\n\n錯誤：\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... 共 ${errors.length} 個錯誤`;
                        }
                    }

                    showAlert(message);
                    if (currentCoachSection === 'training') {
                        loadTrainingPlan();
                    }
                    fileInput.value = '';

                } catch (error) {
                    showAlert(`檔案讀取錯誤：${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadAthleteTemplate() {
            const templateData = [
                {
                    '姓名': '張三',
                    '專項': '100米',
                    '備註': '新手運動員'
                },
                {
                    '姓名': '李四',
                    '專項': '跳高',
                    '備註': '有經驗'
                },
                {
                    '姓名': '王五',
                    '專項': '110米跨欄',
                    '備註': ''
                }
            ];

            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '運動員資料');

            // Set column widths
            worksheet['!cols'] = [
                { width: 15 }, // 姓名
                { width: 15 }, // 專項
                { width: 30 }  // 備註
            ];

            const fileName = `運動員資料範本_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        function downloadTrainingTemplate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            const templateData = [
                {
                    '日期': today.toISOString().split('T')[0],
                    '運動員/群組': '100米',
                    '項目': '衝刺跑',
                    '周期': '基礎期',
                    '組數': '4',
                    '次數': '50米',
                    '重量/強度': '90%',
                    '備註': '注意起跑技術'
                },
                {
                    '日期': today.toISOString().split('T')[0],
                    '運動員/群組': '張三',
                    '項目': '深蹲',
                    '周期': '建構期',
                    '組數': '3',
                    '次數': '8',
                    '重量/強度': '80kg',
                    '備註': '注意膝蓋位置'
                },
                {
                    '日期': tomorrow.toISOString().split('T')[0],
                    '運動員/群組': '跳高',
                    '項目': '技術練習',
                    '周期': '尖峰期',
                    '組數': '10',
                    '次數': '1次',
                    '重量/強度': '比賽高度',
                    '備註': '專注助跑節奏'
                }
            ];

            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '訓練計劃');

            // Set column widths
            worksheet['!cols'] = [
                { width: 12 }, // 日期
                { width: 15 }, // 運動員/群組
                { width: 20 }, // 項目
                { width: 12 }, // 周期
                { width: 8 },  // 組數
                { width: 15 }, // 次數
                { width: 15 }, // 重量/強度
                { width: 30 }  // 備註
            ];

            const fileName = `訓練計劃範本_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }
    </script>

</body></html>
